<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
      <meta name="description" content="Some notes about the UK air traffic control meltdown" />
      
    

      <title></title>

      

      
          <link rel="stylesheet" href="https://jameshaydon.github.io/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https://jameshaydon.github.io">
                                <span itemprop="name">Home</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://jameshaydon.github.io/papers">
                                <span itemprop="name">Papers</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://github.com/jameshaydon/lawvere">
                                <span itemprop="name">lawvere-lang</span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">UK air traffic control meltdown</h1>
        <span class="muted">
    <svg class="icon i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>25 minute read</span>
    <svg class="icon i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2023-09-08
</span>
    </header>
    <div itemprop="articleBody">
      <p>On 28 August 2023 <em>NATS</em>, the UKs air traffic control operator, suffered a major
technical incident. The BBC reports that more than <a href="https://www.bbc.com/news/uk-66685349">2000 flights were
cancelled</a> and the cost has been estimated
at over £100 million GBP. The incident probably affected hundreds of thousands
of people.</p>
<p>These are notes on my reading of:</p>
<blockquote>
<p>NATS Major Incident Preliminary Report</p>
<p>Flight Plan Reception Suite Automated (FPRSA-R) Sub-system Incident 28th August 2023
<a href="https://publicapps.caa.co.uk/docs/33/NERL%20Major%20Incident%20Investigation%20Preliminary%20Report.pdf">pdf</a>.</p>
</blockquote>
<p><em>NATS</em> is a private company in the UK that is responsible for all of the UK's
air-traffic control (ATC).</p>
<blockquote>
<p>As a public-private partnership the UK government holds 49% and a golden
share, with 42% held by the Airline Group, 5% by NATS staff, and 4% by UK
airport operator LHR Airports Ltd.[8][2]
<a href="https://en.wikipedia.org/wiki/NATS_Holdings">wikipedia</a></p>
</blockquote>
<blockquote>
<p>Air Traffic Control (ATC) is the provision and operation of a safe system for
controlling and monitoring aircraft.
[..]</p>
<p>aircraft [..] are required to file a flight plan.
[..]</p>
<p>ATC ensures that aircraft are safely separated laterally and vertically.</p>
</blockquote>
<p>Probably &quot;safely separated laterally <strong>OR</strong> vertically&quot; is more accurate.</p>
<blockquote>
<p>[..] they submit the plan into Eurocontrol’s Integrated Initial Flight Plan
Processing System (IFPS).
[..]</p>
<p>If the submitted flight plan is accepted by IFPS, i.e. it is compliant with
IFPS defined parameters [...] this is sufficient for a flight to depart with
local ATC approval. The flight plan will be sent from IFPS to all relevant
ANSPs who need to manage the flight.
[..]</p>
<p>Within the NATS En-route operations at Swanwick Centre, the data is passed to
FPRSA-R. The FPRSA-R sub-system exists to convert the data received from IFPS
(in a format known as ATS Data Exchange Presentation, ADEXP) into a format
that is compatible with the UK National Airspace System (NAS). NAS is the
flight data processing system which contains all of the relevant airspace and
routings.
[..]</p>
<p>FPRSA-R has a primary and backup system monitored both by dedicated Control
and Monitoring (C&amp;M) systems and also an aggregated central C&amp;M system.
Further resilience is provided by NAS storing 4 hours of previously filed
flight data to allow the operation to continue in the event of the loss of
automatic processing of flight data.
[..]</p>
<p>In addition to the technical resilience provided by backup systems, and the 4
hours of stored flight data, there is operational contingency available to
allow safe service to continue. This is provided through the ability to input
flight data manually, directly into NAS using a manual input system.</p>
</blockquote>
<p>To summarise:</p>
<ul>
<li>Flight plans are first submitted to a European-wide authority <em>IFPS</em>.</li>
<li>If they are accepted, the flight is cleared for takeoff.</li>
<li><em>NATS</em> requires the flight plan be transfered to them at least 4 hours before
the aircraft is due to enter UK airspace (We'll call this <code>T-4H</code>). This is
supposed to give NATS a 4 hour window to be able to fix any problems in
processing flight plans.</li>
<li>It seems that there is also probably some process which <em>delays</em> flight-plans
until <em>close</em> to the <code>T-4H</code> deadline (see below). This might be to avoid
congesting the system with flight plans too early, or lots of plans that may
later change. Still, this results in flight plans being received by NATS
sometimes <em>hours</em> after the flight has taken off.</li>
</ul>
<blockquote>
<p>The NATS ATC System was operating normally.
[..]</p>
<p>[On] 28 August the airline submitted an ICAO4444 compliant flight plan into
Eurocontrol’s flight planning distribution system, IFPS.</p>
</blockquote>
<p>An ICAO4444 flight plan looks like this:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>(FPL-TTT123-IS
</span><span>-C550/L-SDE1E2GHIJ3J5RWZ/SB1D1
</span><span>-KPWM1225
</span><span>-N0440F310 SSOXS5 SSOXS DCT BUZRD
</span><span>DCT SEY DCT HTO J174 ORF J121
</span><span>CHS EESNT LUNNI1
</span><span>-KJAX0214 KMCO
</span><span>-PBN/A1L1B1C1D1O1T1 NAV/Z1 GBAS
</span><span>DAT/1FANS2PDC SUR/260B RSP180
</span><span>DOF/220501 REG/N123A SEL/BPAM
</span><span>CODE/A05ED7)
</span></code></pre>
<p>Such messages are in a format that is meant to be read by machines, but also by
humans if necessary. The format is spec'd over many many pages of PDF, but is
roughly:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>( FPL-ACID-Flt Rules Flight Type
</span><span>- AC Type/Wake Cat-
</span><span>Equip.&amp;Capability
</span><span>- Departure EOBT
</span><span>- Speed Altitude [sp] Route
</span><span>- Destination ETE [sp]
</span><span>Alternate(s)
</span><span>- Other Information )
</span></code></pre>
<p>The route part (in this example: <code>N0440F310 SSOXS5 SSOXS DCT BUZRD DCT SEY DCT HTO J174 ORF J121 CHS EESNT LUNNI1</code>) encodes an overall speed (here <code>N0440</code>
meaning <code>440 knots</code>), an overall altitude (here <code>FL310</code> which means &quot;Flight
Level 310&quot; which means <code>10 × 100 ft</code> (can also be in <code>km</code>)), and a sequence of
waypoints (referenced by name).</p>
<blockquote>
<p>The flight plan was accepted by IFPS
[..]</p>
<p>the aircraft was cleared to depart at 04:00.
[..]</p>
<p>At 08:32 the flight plan was received by NATS’ FPRSA-R sub-system from
Eurocontrol’s IFPS system. This is consistent with the 4 hour rule mentioned
above. The purpose of the FPRSA-R software is to extract the UK portion of the
flight plan [..]</p>
<p>The flight plans delivered to FPRSA-R by IFPS are converted from [..] ICAO4444
to [..] ADEXP. ADEXP is a European-wide flight plan specification that
includes, amongst other data, additional geographical waypoints within the
European region specific to the route of a flight. For flights transiting
through UK airspace, rather than landing in the UK, this will include
additional waypoints outside of UK airspace required for its onward journey.
Following this conversion the ADEXP version of a flight plan includes, amongst
other aspects, the original ICAO4444 flight plan plus an additional list of
waypoints and other data.</p>
</blockquote>
<p>ADEXP looks like this:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>-TITLE IFPL
</span><span>-BEGIN ADDR
</span><span>-FAC LIIRZEZX
</span><span>[...]
</span><span>-FAC LYZZEBXX
</span><span>-END ADDR
</span><span>-ADEP EDDF
</span><span>-ADES LGTS
</span><span>-ARCID KIM1
</span><span>-ARCTYP B738
</span><span>-CEQPT SDGRWY
</span><span>-EOBD 170729
</span><span>-EOBT 0715
</span><span>-FILTIM 280832
</span><span>-IFPLID AT00441635
</span><span>-ORIGIN -NETWORKTYPE SITA -FAC FRAOXLH
</span><span>-SEQPT C
</span><span>-WKTRC M
</span><span>-PBN B2
</span><span>-REG DABHM
</span><span>-SEL KMGJ
</span><span>-SRC FPL
</span><span>-TTLEET 0210
</span><span>-RFL F330
</span><span>-SPEED N0417
</span><span>-FLTRUL I
</span><span>-FLTTYP S
</span><span>-ROUTE N0417F330 ANEKI8L ANEKI Y163 NATOR UN850 TRA UP131 RESIA Q333
</span><span>BABAG UN606 PEVAL DCT PETAK UL607 PINDO UM603 EDASI
</span><span>-ALTRNT1 LBSF
</span><span>-BEGIN RTEPTS
</span><span>-PT -PTID EDDF -FL F004 -ETO 170729073000
</span><span>-PT -PTID RID -FL F100 -ETO 170729073404
</span><span>-PT -PTID ANEKI -FL F210 -ETO 170729073856
</span><span>-PT -PTID NEKLO -FL F214 -ETO 170729073911
</span><span>-PT -PTID BADLI -FL F248 -ETO 170729074118
</span><span>-PT -PTID PABLA -FL F279 -ETO 170729074348
</span><span>-PT -PTID HERBI -FL F308 -ETO 170729074624
</span><span>-PT -PTID NATOR -FL F330 -ETO 170729074911
</span><span>-PT -PTID TITIX -FL F330 -ETO 170729075154
</span><span>-PT -PTID TRA -FL F330 -ETO 170729075323
</span><span>-PT -PTID ARGAX -FL F330 -ETO 170729080055
</span><span>-PT -PTID RESIA -FL F330 -ETO 170729080731
</span><span>-PT -PTID UNTAD -FL F330 -ETO 170729081243
</span><span>-PT -PTID DIKEM -FL F330 -ETO 170729081627
</span><span>-PT -PTID ROKIB -FL F330 -ETO 170729081824
</span><span>-PT -PTID BABAG -FL F330 -ETO 170729082816
</span><span>-PT -PTID PEVAL -FL F330 -ETO 170729082916
</span><span>-PT -PTID PETAK -FL F330 -ETO 170729091754
</span><span>-PT -PTID PINDO -FL F330 -ETO 170729093322
</span><span>-PT -PTID EDASI -FL F165 -ETO 170729094347
</span><span>-PT -PTID LGTS -FL F000 -ETO 170729095713
</span><span>-END RTEPTS
</span><span>-SID ANEKI8L
</span><span>-ATSRT Y163 ANEKI NATOR
</span><span>-ATSRT UN850 NATOR TRA
</span><span>-ATSRT UP131 TRA RESIA
</span><span>-ATSRT Q333 RESIA BABAG
</span><span>-ATSRT UN606 BABAG PEVAL
</span><span>-DCT PEVAL PETAK
</span><span>-ATSRT UL607 PETAK PINDO
</span><span>-ATSRT UM603 PINDO EDASI
</span></code></pre>
<p>You can read about ADEXP in the <a href="https://www.eurocontrol.int/sites/default/files/2023-06/eurocontrol-released-specification-adexp-3-4.pdf" title="pdf">official spec</a>.</p>
<p>Some notable fields (page 48):</p>
<table><thead><tr><th>Adexp Primary Field</th><th>Kind</th><th>Syntax</th><th>Semantic</th></tr></thead><tbody>
<tr><td>route</td><td>b</td><td><code>'-' &quot;ROUTE&quot; {LIM_CHAR}</code></td><td>Complete ICAO Field 15 information containing speed, RFL and route (conforming to the syntax given in Ref. [3]).</td></tr>
<tr><td>rtepts</td><td>c</td><td><code>'-' &quot;BEGIN&quot; &quot;RTEPTS&quot; { pt I ad / vec} '-' &quot;END&quot; &quot;RTEPTS&quot;</code></td><td>List of route points. May also contain an aerodrome identifier.</td></tr>
</tbody></table>
<p>In the example we have the ICAO route:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>-ROUTE N0417F330 ANEKI8L ANEKI Y163 NATOR UN850 TRA UP131 RESIA Q333 BABAG UN606 PEVAL DCT PETAK UL607 PINDO UM603 EDASI
</span></code></pre>
<p>(9 waypoints, 11 if you add the start and end waypoints)</p>
<p>Visually, routes look like:
<img src="https://jameshaydon.github.io/nats-fail/flight_plan.png" alt="some route" title="A flight plan route" /></p>
<p>The <code>ICAO</code> route contains waypoints, seperated by a &quot;known route segment&quot;, a bit
like highways, but for planes. We can indent these to make it clearer:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>N0417F330 : 417 knots, flight level 330
</span><span>ANEKI8L 
</span><span>ANEKI 
</span><span>  Y163
</span><span>NATOR
</span><span>  UN850
</span><span>TRA
</span><span>  UP131
</span><span>RESIA
</span><span>  Q333
</span><span>BABAG
</span><span>  UN606
</span><span>PEVAL
</span><span>  DCT
</span><span>PETAK
</span><span>  UL607
</span><span>PINDO
</span><span>  UM603
</span><span>EDASI
</span></code></pre>
<p>E.g. <code>ANEKI Y163 NATOR</code> means &quot;go from waypoint <code>ANEKI</code> to waypoint <code>NATOR</code> via
the route <code>Y163</code>&quot;. <code>DCT</code> means &quot;direct&quot;.</p>
<p>The <code>ADEXP</code> format has more waypoints, along with more precision about altitude and estimated time at each waypoint:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>-BEGIN RTEPTS
</span><span>-PT -PTID EDDF  -FL F004 -ETO 170729073000
</span><span>-PT -PTID RID   -FL F100 -ETO 170729073404
</span><span>-PT -PTID ANEKI -FL F210 -ETO 170729073856
</span><span>-PT -PTID NEKLO -FL F214 -ETO 170729073911
</span><span>-PT -PTID BADLI -FL F248 -ETO 170729074118
</span><span>-PT -PTID PABLA -FL F279 -ETO 170729074348
</span><span>-PT -PTID HERBI -FL F308 -ETO 170729074624
</span><span>-PT -PTID NATOR -FL F330 -ETO 170729074911
</span><span>-PT -PTID TITIX -FL F330 -ETO 170729075154
</span><span>-PT -PTID TRA   -FL F330 -ETO 170729075323
</span><span>-PT -PTID ARGAX -FL F330 -ETO 170729080055
</span><span>-PT -PTID RESIA -FL F330 -ETO 170729080731
</span><span>-PT -PTID UNTAD -FL F330 -ETO 170729081243
</span><span>-PT -PTID DIKEM -FL F330 -ETO 170729081627
</span><span>-PT -PTID ROKIB -FL F330 -ETO 170729081824
</span><span>-PT -PTID BABAG -FL F330 -ETO 170729082816
</span><span>-PT -PTID PEVAL -FL F330 -ETO 170729082916
</span><span>-PT -PTID PETAK -FL F330 -ETO 170729091754
</span><span>-PT -PTID PINDO -FL F330 -ETO 170729093322
</span><span>-PT -PTID EDASI -FL F165 -ETO 170729094347
</span><span>-PT -PTID LGTS  -FL F000 -ETO 170729095713
</span><span>-END RTEPTS
</span></code></pre>
<p>(21 waypoints)</p>
<p>We can mark which of the ADEXP waypoints have a corresponding waypoint in the ICAO plan (with a <code>+</code>) and which are implicit (with a <code>|</code>): </p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>EDDF   |
</span><span>RID    |
</span><span>ANEKI  + 
</span><span>NEKLO  |
</span><span>BADLI  |
</span><span>PABLA  |
</span><span>HERBI  |
</span><span>NATOR  +
</span><span>TITIX  |
</span><span>TRA    +
</span><span>ARGAX  |
</span><span>RESIA  +
</span><span>UNTAD  |
</span><span>DIKEM  |
</span><span>ROKIB  |
</span><span>BABAG  +
</span><span>PEVAL  |
</span><span>PETAK  +
</span><span>PINDO  +
</span><span>EDASI  +
</span><span>LGTS   |
</span></code></pre>
<p>Note that the ICAO waypoints do not contain the start and end, since in the
original ICAO format these are specified in other fields (so it would waste
space to list them again in this list).</p>
<blockquote>
<p>The ADEXP waypoints plan included two waypoints along its route that were
geographically distinct but which have the same designator.</p>
</blockquote>
<p>This means there were two lines like:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>-PT -PTID RESIA -FL F330 -ETO 170729080731
</span></code></pre>
<p>that had the same <code>PTID</code> string like <code>&quot;RESIA&quot;</code>.</p>
<blockquote>
<p>Although there has been work by ICAO and other bodies to eradicate non-unique
waypoint names there are duplicates around the world. In order to avoid
confusion latest standards state that such identical designators should be
geographically widely spaced. In this specific event, both of the waypoints
were located outside of the UK, one towards the beginning of the route and one
towards the end; approximately 4000 nautical miles apart.</p>
</blockquote>
<p>😐. This is obviously not ideal.</p>
<blockquote>
<p>Once the ADEXP file had been received, the FPRSA-R software commenced
searching for the UK airspace entry point in the waypoint information per the
ADEXP flight plan, commencing at the first line of that waypoint data. FPRSA-R
was able to specifically identify the character string as it appeared in the
ADEXP flight plan text.</p>
<p>Having correctly identified the entry point, the software moved on to search
for the exit point from UK airspace in the waypoint data.</p>
<p>Having completed those steps,</p>
</blockquote>
<p>One thing to note here is that the programming style seems very imperative. This
part of the code succesfully identified an <code>entryPoint</code> and an <code>exitPoint</code>
waypoint to UK airspace in the <code>ADEXP</code> waypoints.</p>
<blockquote>
<p>FPRSA-R then searches the ICAO4444 section of
the ADEXP file.</p>
</blockquote>
<p>It seems at this point, having identified the entry and exit points from the
list of ADEXP waypoints, it will try to extract the UK portion of the flight plan from the ICAO route.</p>
<blockquote>
<p>It initially searches from the beginning of that data, to find
the identified UK airspace entry point. This was successfully found. Next, it
searches backwards, from the end of that section, to find the UK airspace exit
point. This did not appear in that section of the flight plan so the search
was unsuccessful. As there is no requirement for a flight plan to contain an
exit waypoint from a Flight Information Region (FIR) or a country’s airspace,
the software is designed to cope with this scenario.</p>
<p>Therefore, where there is no UK exit point explicitly included, the software
logic utilises the waypoints as detailed in the ADEXP file to search for the
next nearest point beyond the UK exit point. This was also not present.</p>
<p>The software therefore moved on to the next waypoint.</p>
</blockquote>
<p>OK, so I think this is what is going on. The ICAO route contains less waypoints
than the ADEXP data, because some of the waypoints are implicit in the
route segment that is specified between waypoints. So the situation looked
something like this:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>           A       B        C         D              E           F
</span><span>ICAO:  1------7--------2--------3-----------10--------------11-------13
</span><span>
</span><span>ADEXP: 1  12  7   11   2   5    3  8  9     10  4   6   7   11       13
</span><span>                       UK  UK   UK UK UK    UK  UK
</span></code></pre>
<p>Here the ICAO route has waypoints (represented by numbers in this example)
separated by known routes (letters). On the bottom we have the ADEXP waypoints,
along with if they are in the UK or not.</p>
<ul>
<li>The software has identified:
<ul>
<li><code>entryPoint</code>: waypoint <code>2</code></li>
<li><code>exitPoint</code>: waypoint <code>4</code>
in the ADEXP waypoints.</li>
</ul>
</li>
<li>The software finds waypoint <code>2</code> in the ICAO flight plan.</li>
<li>The software <em>does not</em> find waypoint <code>4</code> in the ICAO flight plan.</li>
<li>The software therefore takes the next waypoint in the ADEXP list, so <code>6</code>, and
tries to find it too, and also does not find it.</li>
<li>So it does this again, taking waypoint <code>7</code>, and it <em>does</em> find it, but at the
<em>start</em> of the ICAO flight plan, before the plane even enters the UK.</li>
</ul>
<blockquote>
<p>This search was successful as a duplicate identifier appeared in the flight
plan.</p>
</blockquote>
<p>What should the software have done? Well, <code>7</code> is clearly <em>not</em> the waypoint we
are searching for, we are searching for waypoint <code>11</code>. It's important to note
here that the algorithm is buggy; it is perfectly possibly to extract the UK
portion of the flight plan from this data; see below.</p>
<blockquote>
<p>Having found an entry and exit point, with the latter being the duplicate and
therefore geographically incorrect, the software could not extract a valid UK
portion of flight plan between these two points. This is the root cause of the
incident. We can therefore rule out any cyber related contribution to this
incident.</p>
</blockquote>
<p>It sounds like the exception was raised in a later portion of the code, which
converts the plan to an internal format for <em>NAS</em>. This part failed because the
identified entry/exit waypoints didn't even specify a valid segment of the ICAO
route.</p>
<blockquote>
<p>Safety critical software systems are designed to always fail safely. This
means that in the event they cannot proceed in a demonstrably safe manner,
they will move into a state that requires manual intervention.</p>
</blockquote>
<p>&quot;Demonstably safe&quot; 🤨 --- the code is clearly, demonstrably, <em>unsafe</em>: A portion
of the code contains bugs in identifying the UK portion of an ICAO flight plan.</p>
<blockquote>
<p>In this case the software within the FPRSA-R subsystem was unable to establish
a reasonable course of action that would preserve safety and so raised a
critical exception. A critical exception is, broadly speaking, an exception of
last resort after exploring all other handling options. Critical exceptions
can be raised as a result of software logic or hardware faults, but
essentially mark the point at which the affected system cannot continue.</p>
</blockquote>
<p>It sounds like the software was written thinking this exception would never
occur.</p>
<blockquote>
<p>Clearly a better way to handle this specific logic error would be for FPRSA-R
to identify and remove the message and avoid a critical exception. However,
since flight data is safety critical information that is passed to ATCOs the
system must be sure it is correct and could not do so in this case. It
therefore stopped operating, avoiding any opportunity for incorrect data being
passed to a controller. The change to the software will now remove the need
for a critical exception to be raised in these specific circumstances.</p>
<p>Having raised a critical exception the FPRSA-R primary system wrote a log file
into the system log. It then correctly placed itself into maintenance mode and
the C&amp;M system identified that the primary system was no longer available. In
the event of a failure of a primary system the backup system is designed to
take over processing seamlessly. In this instance the backup system took over
processing flight plan messages. As is common in complex real-time systems the
backup system software is located on separate hardware with separate power and
data feeds.</p>
<p>Therefore, on taking over the duties of the primary server, the backup system
applied the same logic to the flight plan with the same result. It
subsequently raised its own critical exception, writing a log file into the
system log and placed itself into maintenance mode.</p>
<p>At this point with both the primary and backup FPRSA-R sub-systems having
failed safely the FPRSA-R was no longer able to automatically process flight
plans. It required restoration to normal service through manual intervention.
The entire process described above, from the point of receipt of the ADEXP
message to both the primary and backup sub-systems moving into maintenance
mode, took less than 20 seconds. 08:32 therefore marks the point at which the
automatic processing of flight plans ceased and the 4 hour buffer to manual
flight plan input commenced. The steps taken to restore the FPRSA-R sub-system
are described in section 5 of this report.</p>
</blockquote>
<p>The 4 hours were not enough, from the description that follows it sounds like
<em>all</em> engineers were called to help with the situation, and they all scratched
their heads for hours until the manufacturer of the <code>FPRSA-R</code> system was
eventually called. This is an Austrian company, <a href="https://en.wikipedia.org/wiki/Frequentis">Frequentis
AG</a>, which supplied the <code>FPRSA-R</code> in
2018.</p>
<p>We can find a few job ads related to air traffic control systems at Frequenti AG
at their <a href="https://jobs.frequentis.com/careers/SearchJobs/air?listFilterMode=1">careers
page</a></p>
<p>Programming languages used: <code>Ada</code>, <code>C++</code>, <code>Java</code>, <code>Python</code>, with <code>Java</code> being
the most common. Since <code>Ada</code> is the only language in this list that is &quot;safe&quot;
enough for such a critical system, I'll assume it was coded in Ada.</p>
<h2 id="thoughts">Thoughts</h2>
<p>There are two major things that went wrong:</p>
<ol>
<li>The software that processes flight plans (<code>FPRSA-R</code>) was written in a buggy
way.</li>
<li>The <code>FPRSA-R</code> system was badly architected. </li>
<li>The software and system is not properly tested.</li>
<li>NATS was not prepared for <code>FPRSA-R</code> to fail.</li>
<li>Exceptions/failure modes were not audited.</li>
</ol>
<h3 id="the-software-was-buggy">The software was buggy</h3>
<p>The software was incapable to extracting the UK portion of the ICAO flight plan,
even though such a portion exists. I will delve more into this below, but to
summarise:</p>
<ul>
<li>The procedure was very imperative and fiddly, and failed for a silly reason.</li>
<li>While it's true that waypoint markers are not globally unique, but this is a known
issue, so NATS should make sure their systems are robust enough to handle it.
<em>All other air traffic control authories</em> have to deal with this, so NATS
can't just sweep this under a rug and pretend it doesn't exist.</li>
<li>The procedure extracts the UK portion of the flight plan by reconciling
waypoints between the ICAO and ADEXP routes. It's unclear (to me) why it
cannot just use route data from a database on the ICAO flight plan directly.
For example, it could maintain a database of which triples <code>(a, r, b)</code>, where
<code>a</code> and <code>b</code> are waypoints, and <code>r</code> is a route, intersect with UK airspace.</li>
</ul>
<p>NATS officials are trying to spin this as:</p>
<blockquote>
<p>An air traffic meltdown in Britain was caused by a &quot;one in 15 million&quot; event,
the boss of traffic control provider NATS said, as initial findings showed how
a single flight plan with two identically labelled markers caused the chaos.</p>
<p>&quot;This was a one in 15 million chance. We've processed 15 million flight plans
with this system up until this point and never seen this before,&quot; NATS CEO
Martin Rolfe told the BBC, as airlines stepped up calls for compensation for
the breakdown. <a href="https://www.reuters.com/world/uk/uk-aviation-regulator-review-air-traffic-control-failure-2023-09-06/">Reuters</a></p>
</blockquote>
<p>The system was put in place in 2018, so what Martin Rolfe is saying here is
that, this bug only has a chance of occuring &quot;once every 5 years&quot;, which is
apparently an acceptable frequency for having a complete air traffic control
meltdown.</p>
<h3 id="the-fprsa-r-system-was-badly-architected">The <code>FPRSA-R</code> system was badly architected</h3>
<p>The <code>FPRSA-R</code> is meant to process flight plans, and make sure they are safe, and
send them to the relevant ATCOs. When a single flight plan causes a problem,
<em>the entire system crashes</em>, and further flight plans are not processed. Flight
plans can't be processed completely independently of one another, for example
the system has to process them serially (one after another). Indeed, one flight
plan might be allocated some space the next flight plan can not then use.
However, flight plans <em>don't</em> need to be processed in a <em>precise</em> order. Of
course you want to treat them with some degree of fairness, processing them
roughly in the order they come in. But if one flight plan is causing problems,
it can simply be moved to a seperate, slower queue, to be manually processed by
humans.</p>
<p>NATS basically acknowledges this in their &quot;actions already undertaken or in
progress&quot;:</p>
<blockquote>
<p>The addition of specific message filters into the data flow between IFPS and
FPRSA-R to filter out any flight plans that fit the conditions that caused the
incident.</p>
</blockquote>
<h2 id="the-system-is-not-properly-tested">The system is not properly tested</h2>
<p>Apparently NATS and Frequentis have never heard of
<a href="https://en.wikipedia.org/wiki/Fuzzing">fuzzing</a>, for example. By bombarding
such a system with randomly generated flight plans, you can see if any unhandled
exceptions are raised. By inspecting which flight plans cause problems, it would
become apparent that those with duplicate waypoint identifiers in the ADEXP
portion cannot be processed properly.</p>
<p>This allows one to detect &quot;1 in 15 million&quot; events ahead of time.</p>
<h3 id="nats-was-not-prepared-for-fprsa-r-to-fail">NATS was not prepared for <code>FPRSA-R</code> to fail</h3>
<p><code>FPRSA-R</code> is a critical subsystem of the UK's air traffic control
infrastructure. Indeed, if it goes down, chaoes ensues.</p>
<p>Therefore, NATS should have been prepared for dealing with an <code>FPRSA-R</code> failure.
When the system failed:</p>
<ul>
<li>It wrote a message in a log file.</li>
<li>After a while, <em>Frequentis</em> was called to help with accessing and decyphering
the log file.</li>
<li><em>Frequentis</em> engineers were able to identify which flight plan was causing a
problem.</li>
</ul>
<p>Presumably, the part of the log containing the the flight plan was right at the
end of the log file, since flight plans are processed one at a time, and the
system crashed immediately after trying to process the relevant flight plan.</p>
<p>It seems odd that engineers were not able to access this log file, or that they
didn't even think to access it. And once they did, it's odd that they couldn't
work out which flight plan was relevant. Did it not appear in cleartext? In any
case they were not prepared for <code>FPRSA-R</code> to crash.</p>
<p>In fact, as they acknowledge, a lot of this work can be automated:</p>
<blockquote>
<p>An operating instruction has been put in place to allow prompt recovery of the
FPRSA-R sub-system if the same circumstances recur. Each of the technical
operators have been trained to implement the new process. With enhanced
monitoring in place, additional engineering expertise will also be present to
oversee the activity.</p>
</blockquote>
<p>This paints a picture of a team that sits around a magic black box made
somewhere far away. When the magic box stops working, they press the button many
times, and eventually call the people who made the box. It's important to have
expertise in all the system you manage.</p>
<h3 id="exceptions-failure-modes-were-not-audited">Exceptions/failure modes were not audited.</h3>
<p>The programming language used (let's presume Ada) can throw exceptions (most
languages do). For such a critical system, all source-locations where exceptions
are thrown should be audited. For each, the failure message (e.g. written to the
log file) should include the ID of a <em>contingency plan</em>, any any relevant data.
Operators can then look up the contingency plan in some handbook, and start
fixing the problem immediately. In this case the plan would have been something
like:</p>
<ul>
<li>Remove the flight plan that cannot be processed from the message queue.</li>
<li>Restart the <code>FPRSA-R</code> system.</li>
<li>Process the flight plan manually, enter plan manually using 'NAS manual input
system'</li>
</ul>
<h2 id="how-to-code-this-properly">How to code this properly</h2>
<p>So, how can we avoid this bug?</p>
<p>Let's recap the problem. There are two sequences of waypoints:</p>
<ul>
<li>ADEXP: the full list of waypoints.</li>
<li>ICAO: a subsequence of the ADEXP waypoints.</li>
</ul>
<p>Becaause the ICAO plan doesn't need to include the waypoints at which it
enters/exits an air traffic control region, we need to extract a segment of the
ICAO flight plan that contains the UK portion. Of course, the whole ICAO flight
plan satisfies this property, what we really want is the <em>smallest</em> such
segment. It's interesting to note here that a flight could possibly enter UK
airspace, and then exit it again, and enter it again. We'll ignore this, that
is, we will just find a single contiguous segment that contains all UK portions
of the flight, since this is what the original code seemed to do.</p>
<p>First of all, I'm unsure why this task attempts to do this only using the ADEXP
data, rather than consulting a database about how waypoints and flight segments
intersect UK airspace. It seems strange, but lets move on.</p>
<p>Note that it is impossible to achieve this task with the ICAO flight plan alone
(and no knowledge of routes), even if you know for each waypoint if it is in the
UK or not. Indeed you could even be in a situation where <em>none</em> of the waypoints
in the ICAO route are in the UK, for example when the flight plan clips a small
portion of the UK between two of the ICAO waypoints.</p>
<p>So we must use the ADEXP data, and the assumption here, I assume, is that the
ADEXP data contains <em>all</em> the waypoints, and that furthermore, waypoint
granularity is such that if <em>adjacent</em> waypoints both don't intersect UK
airspace, then the segment between them doesn't either. With this in mind, we
can now describe what we want to do:</p>
<p><em>We want to find the smallest subsegment of the ICAO route which fully contains the UK portion(s) of the flight.</em></p>
<p>Given a subsegment of the ICAO route, how do we know if it contains all the UK
waypoints? What we do is work out all the ADEXP waypoints along this subsegment, and then check this contains all the UK waypoints. This is an important function, so let's name it:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#65737e;">-- Given an ICAO subsgment, return the corresponding subsegment of the
</span><span style="color:#65737e;">-- ADEXP waypoints.
</span><span>fullAdexpSub icaoSub =
</span><span>  minimalSub adexp (isSubsequenceOf icaoSub)
</span></code></pre>
<p>This specifies that the ADEXP subsegment corresponding to the ICAO one is that
smallest subsegment of the full ADEXP list that contains the ICAO subsegment as
a subsequence. This uses a function <code>minimalSub</code> which finds a minimal
subsegment of a sequence that matches some property.</p>
<p>Given this function, we can now work out if an ICAO subsegment fully contains the UK portion of the flight:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span>containsUKPortion icaoSub =
</span><span>  </span><span style="color:#b48ead;">case</span><span> fullAdexpSub icaoSub </span><span style="color:#b48ead;">of
</span><span>    </span><span style="color:#d08770;">Just</span><span> adexpSub -&gt; ukWaypoints </span><span style="color:#8fa1b3;">`</span><span>isSubsequenceOf</span><span style="color:#8fa1b3;">`</span><span> adexpSub
</span><span>    </span><span style="color:#d08770;">Nothing </span><span>-&gt; </span><span style="color:#d08770;">False
</span></code></pre>
<p>This says that an ICAO subsegment fully contains the UK portion of a flight if
the corresponding ADEXP subsegment contains all the UK wayspoints as a
subsequence.</p>
<p>Now we can get the sought after UK portion of the ICAO flight plan:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>minimalSub icao containsUKPortion
</span></code></pre>
<p>That is, we want the minimal subsegment of the ICAO route which contains the UK portion.</p>
<p>Putting it all together we get this function:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">ukPortionOfICAO </span><span style="color:#b48ead;">::</span><span> (</span><span style="color:#b48ead;">Eq </span><span style="color:#bf616a;">a</span><span>) </span><span style="color:#b48ead;">=&gt;</span><span> (</span><span style="color:#bf616a;">a </span><span style="color:#b48ead;">-&gt; Bool</span><span>) </span><span style="color:#b48ead;">-&gt;</span><span> [</span><span style="color:#bf616a;">a</span><span>] </span><span style="color:#b48ead;">-&gt;</span><span> [</span><span style="color:#bf616a;">a</span><span>] </span><span style="color:#b48ead;">-&gt; Maybe</span><span> [</span><span style="color:#bf616a;">a</span><span>]
</span><span>ukPortionOfICAO inUK icao adexp = minimalSub icao containsUKPortion
</span><span>  </span><span style="color:#b48ead;">where
</span><span>    containsUKPortion icaoSub =
</span><span>      </span><span style="color:#b48ead;">case</span><span> fullAdexpSub icaoSub </span><span style="color:#b48ead;">of
</span><span>        </span><span style="color:#d08770;">Just</span><span> adexpSub -&gt; ukWaypoints </span><span style="color:#8fa1b3;">`</span><span>isSubsequenceOf</span><span style="color:#8fa1b3;">`</span><span> adexpSub
</span><span>        </span><span style="color:#d08770;">Nothing </span><span>-&gt; </span><span style="color:#d08770;">False
</span><span>
</span><span>    fullAdexpSub icaoSub = minimalSub adexp (isSubsequenceOf icaoSub)
</span><span>
</span><span>    ukWaypoints = filter inUK adexp
</span></code></pre>
<p>Let's test it with our example:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#65737e;">--            A       B        C         D              E           F
</span><span style="color:#65737e;">-- ICAO:  1------7--------2--------3-----------10--------------11-------13
</span><span style="color:#65737e;">--
</span><span style="color:#65737e;">-- ADEXP: 1  12  7   11   2   5    3  8  9     10  4   6   7   11       13
</span><span style="color:#65737e;">--                        UK  UK   UK UK UK    UK  UK
</span><span style="color:#8fa1b3;">example </span><span style="color:#b48ead;">:: Maybe</span><span> [</span><span style="color:#b48ead;">Int</span><span>]
</span><span>example = ukPortionOfICAO inUK icao adexp
</span><span>  </span><span style="color:#b48ead;">where
</span><span>    inUK i = i </span><span style="color:#8fa1b3;">`</span><span>elem</span><span style="color:#8fa1b3;">`</span><span> [</span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">5</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">8</span><span>, </span><span style="color:#d08770;">9</span><span>, </span><span style="color:#d08770;">10</span><span>, </span><span style="color:#d08770;">4</span><span>]
</span><span>    icao = [</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">7</span><span>, </span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">10</span><span>, </span><span style="color:#d08770;">11</span><span>, </span><span style="color:#d08770;">13</span><span>]
</span><span>    adexp = [</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">12</span><span>, </span><span style="color:#d08770;">7</span><span>, </span><span style="color:#d08770;">11</span><span>, </span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">5</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">8</span><span>, </span><span style="color:#d08770;">9</span><span>, </span><span style="color:#d08770;">10</span><span>, </span><span style="color:#d08770;">4</span><span>, </span><span style="color:#d08770;">6</span><span>, </span><span style="color:#d08770;">7</span><span>, </span><span style="color:#d08770;">11</span><span>, </span><span style="color:#d08770;">13</span><span>]
</span></code></pre>
<p>And try this at the REPL:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>λ&gt; example
</span><span>Just [2,3,10,11]
</span></code></pre>
<p>The code returns <code>[2, 3, 10, 11]</code>, which we can see is the correct result:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>                                 UK portion of ICAO
</span><span>                       ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
</span><span>           A       B        C         D              E           F
</span><span>ICAO:  1------7--------2--------3-----------10--------------11-------13
</span><span>
</span><span>ADEXP: 1  12  7   11   2   5    3  8  9     10  4   6   7   11       13
</span><span>                       UK  UK   UK UK UK    UK  UK
</span></code></pre>
<p>Crisis averted. The fact that there is a duplicate identifier in this case is
immaterial, the correct sub-route is still well defined.</p>
<p>For reference here are the helper functions used that were not defined above:</p>
<pre data-lang="haskell" style="background-color:#2b303b;color:#c0c5ce;" class="language-haskell "><code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">smallestSegment </span><span style="color:#b48ead;">::</span><span> (</span><span style="color:#b48ead;">Eq </span><span style="color:#bf616a;">a</span><span>) </span><span style="color:#b48ead;">=&gt;</span><span> [[</span><span style="color:#bf616a;">a</span><span>]] </span><span style="color:#b48ead;">-&gt; Maybe</span><span> [</span><span style="color:#bf616a;">a</span><span>]
</span><span>smallestSegment = minimumBy isInfixOf
</span><span>
</span><span style="color:#8fa1b3;">minimalSub </span><span style="color:#b48ead;">::</span><span> (</span><span style="color:#b48ead;">Eq </span><span style="color:#bf616a;">a</span><span>) </span><span style="color:#b48ead;">=&gt;</span><span> [</span><span style="color:#bf616a;">a</span><span>] </span><span style="color:#b48ead;">-&gt;</span><span> ([</span><span style="color:#bf616a;">a</span><span>] </span><span style="color:#b48ead;">-&gt; Bool</span><span>) </span><span style="color:#b48ead;">-&gt; Maybe</span><span> [</span><span style="color:#bf616a;">a</span><span>]
</span><span>minimalSub xs p =
</span><span>  smallestSegment [s | s &lt;- subsegments xs, p s]
</span><span>
</span><span style="color:#8fa1b3;">minimumBy </span><span style="color:#b48ead;">::</span><span> (</span><span style="color:#bf616a;">a </span><span style="color:#b48ead;">-&gt; </span><span style="color:#bf616a;">a </span><span style="color:#b48ead;">-&gt; Bool</span><span>) </span><span style="color:#b48ead;">-&gt;</span><span> [</span><span style="color:#bf616a;">a</span><span>] </span><span style="color:#b48ead;">-&gt; Maybe </span><span style="color:#bf616a;">a
</span><span>minimumBy lessOrEq xs = find (\x -&gt; all (lessOrEq x) xs) xs
</span><span>
</span><span style="color:#8fa1b3;">subsegments </span><span style="color:#b48ead;">::</span><span> [</span><span style="color:#bf616a;">a</span><span>] </span><span style="color:#b48ead;">-&gt;</span><span> [[</span><span style="color:#bf616a;">a</span><span>]]
</span><span>subsegments xs = </span><span style="color:#d08770;">[] </span><span>: concatMap (filter (not . null) . tails) (inits xs)
</span></code></pre>
<p>In subsequent posts I will show how this implementation, and the faulty one
could have been tested, verified, and optimized.</p>

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by James Haydon
                
                
                
            </p>
            
            
        </footer>
    
</article>


    </body>

</html>
